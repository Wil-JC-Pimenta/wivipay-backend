global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # WiPay Gateway Application
  - job_name: 'wipay-gateway'
    metrics_path: '/api/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8082']
    scrape_interval: 10s
    scrape_timeout: 5s
    honor_labels: true
    
    # Relabeling para adicionar labels customizados
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+)(?::\d+)?'
        replacement: '${1}'
      
      - source_labels: [__address__]
        target_label: service
        replacement: 'wipay-gateway'
      
      - source_labels: [__address__]
        target_label: environment
        replacement: 'development'

  # PostgreSQL Database
  - job_name: 'postgres'
    static_configs:
      - targets: ['localhost:9187']
    scrape_interval: 30s

  # RabbitMQ
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['localhost:15692']
    scrape_interval: 30s

  # Keycloak (se tiver métricas expostas)
  - job_name: 'keycloak'
    static_configs:
      - targets: ['localhost:8180']
    metrics_path: '/metrics'
    scrape_interval: 60s

# Alerting rules para WiPay
rule_files:
  - 'wipay-alerts.yml'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Recording rules para métricas customizadas
recording_rules:
  - record: wipay:payments:success_rate
    expr: rate(wipay_payments_authorizations_total[5m]) / (rate(wipay_payments_authorizations_total[5m]) + rate(wipay_payments_failures_total[5m]))
  
  - record: wipay:customers:growth_rate
    expr: rate(wipay_customers_creations_total[1h])
  
  - record: wipay:credit_cards:active_count
    expr: wipay_credit_cards_total
  
  - record: wipay:transactions:volume_total
    expr: sum(wipay_payments_amount_total)
  
  - record: wipay:errors:error_rate
    expr: rate(wipay_errors_total[5m])
  
  - record: wipay:response_time:p95
    expr: histogram_quantile(0.95, rate(wipay_payments_processing_time_seconds_bucket[5m]))
  
  - record: wipay:response_time:p99
    expr: histogram_quantile(0.99, rate(wipay_payments_processing_time_seconds_bucket[5m]))

# Configuração de storage
storage:
  tsdb:
    path: /prometheus/data
    retention.time: 30d
    retention.size: 10GB

# Configuração de WAL
wal:
  dir: /prometheus/wal
  retention.period: 24h

# Configuração de exemplos de métricas
# Estas são as métricas que esperamos ver do WiPay Gateway:
# - wipay_payments_authorizations_total
# - wipay_payments_captures_total
# - wipay_payments_refunds_total
# - wipay_payments_failures_total
# - wipay_payments_processing_time_seconds
# - wipay_customers_creations_total
# - wipay_customers_updates_total
# - wipay_customers_deletions_total
# - wipay_customers_operation_time_seconds
# - wipay_credit_cards_creations_total
# - wipay_credit_cards_updates_total
# - wipay_credit_cards_deletions_total
# - wipay_credit_cards_operation_time_seconds
# - wipay_transaction_logs_created_total
# - wipay_errors_total
